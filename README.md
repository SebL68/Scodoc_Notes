Pour suivre les √©volutions, l'id√©al est d'aller voir sur le Discord.
L'assistance et les discussions par rapport √† cette passerelle se font sur le Discord Assistance de Scodoc : https://discord.gg/FgMNZ4SdD4

Les utilisateurs actuels sont :
| Etablissement | Acc√®s √©tudiants | Acc√®s enseignants | Saisie des absences | D√©p√¥t de jusitificatifs |
|---|---|---|---|---|
| IUT de Mulhouse | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| IUT de Ville d'Avray | ‚úÖ | ‚úÖ |  | ‚úÖ |
| IUT de Chartres | ‚úÖ | ‚úÖ |  |  |
| IUT de Lyon 1 | ‚úÖ | ‚úÖ |  |  |
| IUT de Tours | ‚úÖ |  |  |  |
| IUT de Lannion | ‚úÖ |  |  |  |
| IUT de Lille | ‚úÖ | ‚úÖ |  |  |
| IUT de Bordeaux | ‚úÖ | ‚úÖ |  |  |
| IUT d'Orsay | ‚úÖ | ‚úÖ |  |  |
| IUT Le Havre | ‚úÖ | ‚úÖ |  |  |
| IUT de Poitiers | ? |  |  |  |
| IUT du Littoral C√¥te d'Opale | ? |  |  |  |
| IUT de La Rochelle | ‚úÖ |  |  |  |
| IUT Le Mans | ‚úÖ | ‚úÖ |  |  |
| IUT de Mantes-En-Yvelines | ‚úÖ |  |  |  |
| IUT de Saint-Malo | ‚úÖ | ‚úÖ |  |  |
| IUT de la Roche-sur-Yon | ‚úÖ |  |  |  |
| IUT de V√©lizy | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| IUT de Roanne | ? |  |  |  |
| IUT de Kourou | ‚úÖ | ‚úÖ | ‚úÖ |  |
| IUT de Brest | ‚úÖ |  |  |  |
| IUT de d'Annecy | ‚úÖ | ‚úÖ |  |  |
| IUT de Nantes | ‚úÖ | ‚úÖ |  |  |
| IUT de Blagnac | ‚úÖ |  |  |  |
| IUT de Vannes | ? |  |  |  |
| IUT de Lorient & Pontivy | ? |  |  |  |
| IUT de Orl√©ans | ‚úÖ |  |  |  |
| IUT de Rennes | ‚úÖ | ‚úÖ |  |  |
| IUT de Perpignan sites de Narbonne et Carcassonne | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| IUT de Villetaneuse | ‚úÖ | ‚úÖ |  |  |
| IUT de Cergy-Pontoise | ‚úÖ | ‚úÖ |  |  |
| IUT de Mantes | ? |  |  |  |
| IUT de B√©ziers | ‚úÖ |  |  |  |
| IUT de Saint Denis | A venir |  |  |  |
| IUT d'Amiens | ‚úÖ |  |  |  |
| IUT de Caen (IFS) | ‚úÖ |  |  |  |
| IUT de Saint-Nazaire | ‚úÖ | ‚úÖ |  |  |
| IUT de Montpellier-S√®te | ‚úÖ |  |  |  |
| IUT de Cachan | ‚úÖ | ‚úÖ |  |  |
| IUT Nord Franche-Comt√© | ‚úÖ |  |  |  |
| IUT de Montreuil | ‚úÖ |  |  |  |
| IUT de Schiltigheim | ‚úÖ |  |  |  |
| Ecole de chimie de Mulhouse (ENSCMu) | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| IUT d'Evry | ‚úÖ | ‚úÖ |  |  |
| IUT de B√©thune | ‚úÖ |  |  |  |
| IUT de Lyon 3 | ‚úÖ |  |  |  |
| IUT de S√©nart-Fontainebleau | ‚úÖ | ‚úÖ |  |  |
| IUT de Paris Pajol | ‚úÖ |  |  |  |
| IUT de Saint-Brieuc | ‚úÖ |  |  |  |
| IUT de Sceaux | Installation en cours |  |  |  |
  
Vous utilisez aussi ce projet ? N'h√©sitez pas √† m'en informer pour √™tre √©galement dans cette liste : sebastien.lehmann (at) uha.fr :-)   
  
Vous pouvez utiliser le projet en entier pour plus de simplicit√© ou utiliser des parties pour coder votre propre plateforme.  
  
# A quoi sert cette passerelle ?
La passerelle Scodoc-Notes est un projet permettant de faire le lien entre Scodoc et les √©tudiants.  
Les √©tudiants peuvent consulter en ligne leurs notes. La passerelle g√®re automatiquement l'affichage des relev√©s pour les DUT et pour les BUT que ce soit sur mobile ou sur ordinateur.  
  
Il est possible de configurer un acc√®s "enseignant". Cet acc√®s permet aux utilisateurs reconnus de :
 - consulter le relev√© de n'importe quel √©tudiant,
 - r√©cup√©rer la liste des groupes, des fiches d'√©margement, de quoi renvoyer les notes, etc. : ces fichiers sont synchronis√©s avec Scodoc.
  
Cet acc√®s est notamment utile pour les vacataires qui n'ont pas acc√®s √† Scodoc, ils peuvent alors r√©cup√©rer des fichiers √† jour d√®s qu'ils en ont besoin.  

Enfin, la passerelle permet de saisir et justifier les absences de mani√®re autonome ou en stockant les donn√©es dans Scodoc.  
  
# Guide d'installation
## Syst√®me requis  
  
 - Il est recommand√© d'avoir un syst√®me Debian ou Ubuntu, pour pouvoir utiliser l'installeur automatique, mais √ßa peut fonctionner avec d'autres syst√®mes.
 - Il est n√©cessaire d'avoir PHP version 7.3 ou plus - compatibilit√© test√©e avec PHP 8.2
 - Il est recommand√© d'utiliser Apache, mais √ßa fonctionne avec Nginx - il faudra juste un peu de config manuelle.
 - Les d√©pendances sont install√©es automatiquement.
 - Le serveur doit √™tre reconnu et autoris√© par le CAS.  
 - Le serveur doit pouvoir communiquer avec Scodoc.  
  
## Installation automatique (recommand√©)
  
Le script : `/installOrUpdate.sh`  permet d'installer et de mettre √† jour la passerelle.
Ce script est compatible Ubuntu et Debian, il permet lors d'une premi√®re installation d'installer tout le n√©cessaire sur le serveur, il reste alors √† configurer les fichiers `/config/*`  
  
Lorsque le serveur est d√©j√† op√©rationnel, il permet de faire une mise √† jour de /html, /includes et /lib.
  
Le virtual host doit mener vers le dossier `/var/www/html`. Les fichiers √† s√©curiser sont install√©s dans `/var/www`, les fichiers publics sont dans `/var/www/html`.  
Pour des raisons de s√©curit√©, si le virtual host est mal configur√©, la passerelle ne fonctionnera pas.  
Il est possible de configurer un virtual host vers un autre dossier en respectant le principe : `path` fichiers non accessibles, `path/html` fichiers publics.  
  
T√©l√©charger et ajouter le fichier `installOrUpdate.sh` dans le r√©pertoire `/var/www` en tant que ROOT :  
```
cd /var/www
wget -q https://raw.githubusercontent.com/SebL68/Scodoc_Notes/main/installOrUpdate.sh
chmod +x installOrUpdate.sh

# puis pour installer
./installOrUpdate.sh
```
  
Proc√©dure de mise √† jour par la suite :  
```
cd /var/www
./installOrUpdate.sh
```  

üí° Nous vous recommandons d'ex√©cuter ce script toutes les nuits avec une tache cron.  
  
[Option]  
Par d√©faut, la mise √† jour se fait dans `/var/www/`.  
Le script accepte comme param√®tre un chemin diff√©rent afin de permettre la mise √† jour pour ceux qui ont configur√© des Virtual Hosts.  
`./installOrUpdate.sh cheminVersLaPasserelle`  
  
Voir "Diagnostic" et "Configuration" pour la suite.  
  
# Principe de la passerelle
L'identification de la personne se fait le CAS.  
Le CAS renvoie soit :
 - le num√©ro d'√©tudiant,
 - une variante du num√©ro d'√©tudiant qu'il est possible de transformer dans le fichier config,
 - un autre identifiant, comme l'adresse mail,
 - il est aussi possible de r√©cup√©rer le num√©ro s'il est dans un autre champs renvoy√© par le CAS.
  
C'est le num√©ro d'√©tudiant qui est n√©cessaire pour communiquer avec Scodoc, s'il n'est pas possible de r√©cup√©rer le num√©ro d'√©tuidant ou une variante dans un des champs du CAS, il faut mettre en place un syst√®me de correspondance.  
Cette correspondance est faite dans les fichiers /data/annuaires/liste_etu.txt

Il est possible d'automatiser la g√©n√©ration de ces fichiers √† partir du LDAP (voir ci-apr√®s).  
  
## Diagnostic
Pour vous aider dans la configuration de votre serveur, un syst√®me de diagnostic a √©t√© mis en place : /html/sercices/diagnostic.php?-no-sw  
  
Exemple : https://notes.iutmulhouse.uha.fr/services/diagnostic.php?-no-sw
  
Lors de l'utilisation de la passerelle, il est √©galement possible d'activer les messages d'erreur dans /html/services/data.php --> Options de debug  
La passerelle communique via un syst√®me d'API, il faut donc voir les r√©ponses dans l'inspecteur (F12) --> Network  
 
## Configuration
### Configuration Scodoc
Il est n√©cessaire d'avoir un utilisateur avec les droits de lecture pour l'API Scodoc : https://scodoc.org/ScoDoc9API/#configuration-de-scodoc-pour-utiliser-lapi

### Configuration Passerelle
  
L'ensemble des fichiers √† configurer se trouvent dans "/config/".
Il est √† minima n√©cessaire de configurer :
  - cas.pem (recommand√© pour des raisons de s√©curit√© : https://www.php.net/manual/fr/function.curl-setopt.php#110457),
  - cas_config.php,
  - config.php 
  
Il est recommand√© d'avoir un super-administrateur en incluant son identifiant CAS dans le fichier /data/annuaires/super_admin.txt (enlevez le _DEMO).
  
### Configuration de l'authentification : CAS
Compl√©tez cas_config.php.  
Pour vous aider √† tester, vous pouvez utiliser le syst√®me de diagnostique.  
Vous pouvez √©galement utiliser le fichier /code_test/testCAS.php pour comprendre ce qui est renvoy√© par le CAS.  
  
Il est n√©cessaire d'obtenir un num√©ro d'√©tudiant tel qu'il est dans Scodoc, plusieurs cas de figures :  
 - l'identifiant au CAS est le num√©ro d'√©tudiant : il n'y a rien √† faire,
 - l'identifiant est un variant du num√©ro d'√©tudiant, il peut y avoir une lettre qui change ou autres, dans ce cas il est possible d'op√©rer une transfromation avec la fonction nipModifier() dans le fichier config,
 - l'identifiant est disponible dans un autre attribut renvoy√© par le CAS (voir /code_test/testCAS.php) : il est possible d'indiquer quelle cl√© utiliser dans le fichier config : public static $CAS_nip_key = 'cle';
 - l'identifiant n'est pas accessible, il faut donc utiliser le LDAP pour avoir une correspondance entre l'idCAS et le nip.
  
L'utilisation du LDAP n'est pas obligatoire si le CAS renvoie le nip. Si par exemple le CAS renvoie l'adresse mail, il faut alors mettre en place le syst√®me qui permet de convertir les mails en nip. Dans /data/annuaires, il y a les fichiers pour cette conversion. Diff√©rentes fonctions permettent de remplir ces fichiers automatiquement √† partir du LDAP (voir ci-apr√®s).  
  
Pour tester la connexion avec Scodoc, il est possible de forcer un utilisateur (√©tudiant) dans /config/config.php => nipModifier().
  
Il est possible de s'authentifier de mani√®re forc√©e en utilisant les jetons JWT.  
Ces jetons peuvent √™tre cr√©√©s dans le fichier /html/services/createJWT.php (√† modifier).  
Ces jetons sont notamment utiles au d√©but pour bypasser le CAS pour des premiers tests.  

### Option - configuration du LDAP
Compl√©tez les param√®tres LDAP dans /config/config.php  
La mise √† jour forc√©e du LDAP (pour les tests) se fait en ex√©cutant le fichier /includes/CmdUpdateLists.php en CLI.  
La mise en route du crontab se fait avec le fichier /includes/CmdSetUpdateLists.php suivant le m√™me principe.  
  
## A noter
  
Par d√©faut, ce site ne diffuse que les relev√©s de notes aux √©tudiants.  
Il est possible d'activer d'autres options pr√©vus pour les enseignants comme :
 - la possibilit√© de visualiser les relev√©s de n'importe quel √©tudiant,
 - r√©cup√©rer des documents xls pratiques, automatiquement g√©n√©r√©s en fonction des listes Scodoc,
 - g√©rer les absences enti√®rement depuis la passerelle, avec des cr√©neaux pr√©d√©finis (sans utiliser Scodoc).  
 
Les super-admin ont un onglet suppl√©mentaire pour configurer la passerelle en ligne.  
Ils peuvent √©galement attribuer les r√¥les admin ou personnel √† des idCAS.  
  
Si le mode enseignant est activ√©, les idCAS reconnus comme "personnel" pourront avoir acc√®s aux relev√©s de tous les √©tudiants et r√©cup√©rer les listes au format xlsx.  
Si le mode absences est activ√©, la passerelle permet de r√©aliser les absences par les personnels, un admin pourra justifier ces absences - a noter que le module absence n'est pas connect√© √† Scodoc pour le moment - ces absences sont automatiquement affich√©es aux √©tudiants.  
  
Il est √©galement possible d'utiliser le LDAP pour remplir automatiquement les listes des personnels.  
  
_______________  
  
Les √©tudiants peuvent modifier leur "avatar" sur la passerelle, il faut v√©rifier que l'utiliseur www-data puisse bien modifier les fichiers du r√©pertoire /data/studentPic  
   
# Comment conna√Ætre la version de la passerelle ?
La version est not√©e dans le fichier /html/sw.js  
Il est √©galement possible de la voir en bas de la page d'accueil de la passerelle.

# Proc√©dures de mise √† jour
Les dossiers /config et /data sont des donn√©es locales qui permettent de faire fonctionner la passerelle dans votre environnement.  
Ils ne sont (sauf cas exceptionnels) pas modifi√©s.  
Utilisez alors le script `installOrUpdate.sh`

# Indications pour les d√©veloppeurs
La passerelle utilise un syst√®me de cache c√¥t√© client utilisant un service worker.  
Il y faut alors le prendre en compte de cette mani√®re :
 - certains fichiers, comme l'index, ne sont pas mis √† jour tant que la version du SW n'est pas mis √† jour,
 - les autres fichiers sont mis √† jour apr√®s le chargement de la page.

Il faut donc faire un double rafra√Æchissement pour voir la derni√®re version de ces derniers fichiers.  
  
Je vous conseille alors, pour le d√©veloppement, de "bypasser" le service worker - sous Chrome : F12 -> Applications -> Service Worker  

_________________________

Pour des d√©veloppements locaux et des commits, il est n√©cessaire de ne pas prendre en compte les modifications de certains fichiers, il est alors possible de ne pas les ajouter √† l'arbre GIT avec :  
`git update-index --skip-worktree config/config.php`
  
  
# Consid√©rations de s√©curit√©
La passerelle a fait l'objet d'une attention particuli√®re aux probl√®mes de s√©curit√© et plusieurs personnes ont audit√© le code : il n'y a aucune faille connue.  
